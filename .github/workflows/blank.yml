name: Build FreeType Android (Tiny Size)

on: 
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Install Ninja & CMake
      run: sudo apt-get install -y ninja-build cmake

    - name: Setup Android NDK r23c
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r23c
        
    - name: Download & Extract FreeType 2.13.3
      run: |
        wget https://download.savannah.gnu.org/releases/freetype/freetype-2.13.3.tar.gz
        tar -xvf freetype-2.14.1.tar.gz
        mv freetype-2.14.1 freetype-src
        
    # --- 2. 编译 32位 (ARMv7) [体积优化版] ---
    - name: Build ARMeabi-v7a (Tiny)
      run: |
        mkdir build_32
        cd build_32
        cmake \
          -G "Ninja" \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=armeabi-v7a \
          -DANDROID_PLATFORM=android-24 \
          -DANDROID_STL=c++_static \
          -DCMAKE_BUILD_TYPE=MinSizeRel \
          -DCMAKE_C_FLAGS="-Oz -ffunction-sections -fdata-sections" \
          -DFT_DISABLE_ZLIB=ON \
          -DFT_DISABLE_BZIP2=ON \
          -DFT_DISABLE_PNG=ON \
          -DFT_DISABLE_HARFBUZZ=ON \
          -DFT_DISABLE_BROTLI=ON \
          ../freetype-src
        ninja

    # --- 3. 整理文件 ---
    - name: Organize Output
      run: |
        mkdir -p libs/armeabi-v7a
        cp build_32/libfreetype.a libs/armeabi-v7a/

    # --- 4. 上传 ---
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libfreetype_tiny
        path: libs/
